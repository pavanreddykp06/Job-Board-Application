{% extends "common.html" %}
{% load tz %}

{% block content %}
<div class="container my-5">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <h3 class="mb-0">Manage Jobs</h3>
    <a href="{% url 'post_job' %}" class="btn btn-success">+ Post New Job</a>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <!-- Filter Form -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-sm-6 col-md-2">
      <label for="jobType" class="form-label">Job Type</label>
      <select name="job_type" id="jobType" class="form-select form-select-sm">
        <option value="all" {% if selected_job_type == 'all' %}selected{% endif %}>All</option>
        <option value="Full-Time" {% if selected_job_type == 'Full-Time' %}selected{% endif %}>Full-Time</option>
        <option value="Part-Time" {% if selected_job_type == 'Part-Time' %}selected{% endif %}>Part-Time</option>
        <option value="Internship" {% if selected_job_type == 'Internship' %}selected{% endif %}>Internship</option>
        <option value="Remote" {% if selected_job_type == 'Remote' %}selected{% endif %}>Remote</option>
      </select>
    </div>

    <div class="col-sm-6 col-md-2">
      <label for="statusFilter" class="form-label">Status</label>
      <select name="status" id="statusFilter" class="form-select form-select-sm">
        <option value="all" {% if selected_status == 'all' %}selected{% endif %}>All</option>
        <option value="active" {% if selected_status == 'active' %}selected{% endif %}>Active</option>
        <option value="expired" {% if selected_status == 'expired' %}selected{% endif %}>Expired</option>
      </select>
    </div>

    <div class="col-sm-6 col-md-2">
      <label for="locationCity" class="form-label">City</label>
      <input type="text" name="location_city" id="locationCity" value="{{ location_city }}" class="form-control form-control-sm" placeholder="City">
    </div>

    <div class="col-sm-6 col-md-2">
      <label for="locationState" class="form-label">State</label>
      <input type="text" name="location_state" id="locationState" value="{{ location_state }}" class="form-control form-control-sm" placeholder="State">
    </div>

    <div class="col-auto align-self-end">
      <button type="submit" class="btn btn-primary btn-sm">Filter</button>
      <a href="{% url 'manage_jobs' %}" class="btn btn-secondary btn-sm">Reset</a>
    </div>
  </form>

  {% if jobs %}
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Title</th>
            <th>Type</th>
            <th>Location</th>
            <th>Deadline</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% now "Y-m-d" as today %}
          {% for job in jobs %}
            <tr class="clickable-row" data-href="{% url 'job_detail' job.id %}" tabindex="0" role="link" aria-label="View details for {{ job.title }}">
              <td>{{ job.title }}</td>
              <td>{{ job.job_type }}</td>
              <td>{{ job.location_city }}, {{ job.location_state }}</td>
              <td>{{ job.deadline }}</td>
              <td>
                {% if job.deadline|stringformat:"s" < today %}
                  <span class="badge bg-danger">Expired</span>
                {% else %}
                  <span class="badge bg-success">Active</span>
                {% endif %}
              </td>
              <td>
                <a href="{% url 'edit_job' job.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
                <a href="{% url 'delete_job' job.id %}" class="btn btn-sm btn-outline-danger">Delete</a>
                <a href="{% url 'view_applicants' job.id %}" class="btn btn-sm btn-outline-info">Applicants</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-muted mt-4">You haven't posted any jobs yet.</p>
  {% endif %}
</div>

<!-- Clickable Row Script -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const rows = document.querySelectorAll(".clickable-row");
    rows.forEach(row => {
      row.style.cursor = 'pointer';
      row.addEventListener("click", function (e) {
        if (e.target.tagName === 'A' || e.target.closest('a')) return;
        window.location.href = row.dataset.href;
      });
      row.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          window.location.href = row.dataset.href;
        }
      });
    });
  });
</script>
{% endblock %}
